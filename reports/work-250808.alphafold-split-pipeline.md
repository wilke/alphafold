# Work Summary Report - AlphaFold Split Pipeline Testing

**Date:** 2025-08-08  
**Project:** AlphaFold Split Pipeline  
**Duration:** 2025-08-07 to 2025-08-08 (ongoing)  

## Tasks Completed

### 1. Fixed Split Pipeline Test Infrastructure
- **Issue**: Container execution errors due to incorrect bind mount placement
- **Solution**: Moved bind flags to `apptainer exec` command instead of as arguments to Python script
- **Files Modified**: `test_split_pipeline.sh` (lines 122-141, 223-234)

### 2. Added Model Parameters Binding for Inference
- **Issue**: Inference failed with "FileNotFoundError: params_model_1.npz"
- **Solution**: Added explicit bind mount for params directory in inference command
- **File Modified**: `test_split_pipeline.sh` - added `--bind "$DB_DIR/params:/app/alphafold/data/params:ro"`

### 3. Successfully Ran Split Pipeline Test
- **1VII Protein (36 residues)**:
  - Preprocessing: Reused existing features.pkl (saved 20 minutes)
  - Inference: Completed in 460 seconds (7:40 minutes)
  - GPU Usage: Distributed across all 8 GPUs
  - Memory: 11.96 GB peak during inference
  - Output: 5 ranked PDB structures successfully generated

### 4. Created Monitoring and Direct Test Scripts (**DEPRECATED - August 15, 2025**)
- ~~`run_inference_1VII.sh`~~ - Direct inference runner for debugging (**DELETED - superseded by comprehensive testing framework**)
- ~~`monitor_full_test.sh`~~ - Real-time test progress monitoring (**DELETED - superseded by comprehensive testing framework**)
- ~~`test_direct_preprocess.sh`~~ - Standalone preprocessing validator (**DELETED - superseded by comprehensive testing framework**)

**Note**: These scripts were superseded by the comprehensive testing framework developed August 7-15, 2025. Current testing capabilities are provided by the scripts in `/test_scripts/` directory.

## Work in Progress

### Ubuntu 22.04 Apptainer Test
- **Started**: 11:52 AM CDT
- **Container**: alphafold_ubuntu22.1.sif  
- **Status**: ‚ùå FAILED - CUDNN initialization error
- **Failure Point**: Model parameter loading (before inference begins)
- **Error**: `CUDNN_STATUS_NOT_INITIALIZED` when JAX tries to create GPU arrays
- **Root Cause**: Incompatibility between Ubuntu 22.04 CUDNN packaging and JAX expectations
- **1VII Preprocessing**: ‚úÖ Complete (1132s, 44GB RAM) - worked perfectly
- **Key Finding**: CPU operations work fine, GPU initialization fails immediately

## Completed Work

### Split Pipeline Full Test Suite
- **Current Status**: ‚úÖ ALL TESTS COMPLETE
- **Progress**:
  - ‚úÖ 1VII (36 aa): Complete
  - ‚úÖ 1UBQ (76 aa): Complete
  - ‚úÖ 1LYZ (129 aa): Complete
  - ‚úÖ 1MBN (153 aa): Complete

### Completed Timings

**1VII (36 residues)**:
- Preprocessing: Reused existing features
- Inference: 460s (7:40 minutes), 11.96GB RAM
- Total: 460s (features reused)

**1UBQ (76 residues)**:
- Preprocessing: 1311s (21:51 minutes), 45.7GB RAM
  - UniRef90 search: 358 seconds (~6 minutes)
  - MGnify search: 575 seconds (~9.5 minutes)  
  - HHsearch (PDB70): 14 seconds
  - HHblits (BFD+UniRef30): 300 seconds (5 minutes)
- Inference: 519s (8:39 minutes), 12.3GB RAM
  - Model 1: 220.6s with compilation, 7.7s without
  - Model 2: 56.3s with compilation, 5.3s without
  - Model 3: 54.5s with compilation, 7.6s without
  - Model 4: 44.3s with compilation, 7.6s without
  - Model 5: 46.5s with compilation, 5.2s without
  - CPU Relaxation (model 2): 17.5s
- Total Pipeline: 1830s (30:30 minutes)

**1LYZ (130 residues)**:
- Preprocessing: 1196s (19:56 minutes), 44.0GB RAM
  - UniRef90 search: 354 seconds
  - MGnify search: 572 seconds
  - HHsearch (PDB70): 15 seconds
  - HHblits (BFD+UniRef30): 251 seconds
  - Features size: 8.2MB (largest so far)
- Inference: 564s (9:24 minutes), 12.8GB RAM
  - Model 1: 250.2s with compilation, 9.5s without
  - Model 2: 58.8s with compilation, 7.1s without  
  - Model 3: 55.4s with compilation, 9.2s without
  - Model 4: 45.2s with compilation, 9.2s without
  - Model 5: 46.9s with compilation, 6.8s without
  - CPU Relaxation (model 2): 18.4s
- Total Pipeline: 1760s (29:20 minutes)

**1MBN (154 residues)**:
- Preprocessing: 1253s (20:53 minutes), 44.5GB RAM
  - UniRef90 search: 356 seconds
  - MGnify search: 572 seconds
  - HHsearch (PDB70): 16 seconds
  - HHblits (BFD+UniRef30): 304 seconds
  - Features size: 6.4MB
- Inference: 574s (9:34 minutes), 12.8GB RAM
  - Model 1: 252.8s with compilation, 10.2s without
  - Model 2: 59.9s with compilation, 7.7s without
  - Model 3: 56.6s with compilation, 9.9s without
  - Model 4: 46.7s with compilation, 9.9s without
  - Model 5: 48.2s with compilation, 7.3s without
  - CPU Relaxation (model 2): 18.1s
- Total Pipeline: 1827s (30:27 minutes)

## Code Changes Summary

### Files Modified
1. **test_split_pipeline.sh**
   - Fixed bind mount placement for container execution
   - Added params directory binding for inference
   - Changed from `apptainer run` to `apptainer exec`

### Key Functions Updated
- `run_preprocessing()` - Fixed container bind mounts (lines 122-141)
- `run_inference()` - Added params binding (lines 223-234)

### Test Results Data
- `/scratch/alphafold_split_pipeline_test/preprocessing_results.csv`
- `/scratch/alphafold_split_pipeline_test/inference_results.csv`

## Next Steps

1. ‚úÖ **Full Test Suite Complete**
   - All 4 proteins successfully processed
   - Complete timing and resource metrics collected

2. ‚úÖ **Scaling Analysis Generated**
   - Created comprehensive analysis in `/scratch/alphafold_split_pipeline_test/scaling_analysis.md`
   - Key finding: Preprocessing ~constant time, inference scales sub-linearly
   - Split pipeline benefits clearly demonstrated

3. **Remaining Tasks**
   - Fix analysis script error in test_split_pipeline.sh
   - Create visualization charts if needed
   - Deploy to production pipeline

## Container Compatibility Analysis

### Ubuntu 20.04 vs Ubuntu 22.04 Comparison

| Aspect | Ubuntu 20.04 | Ubuntu 22.04 |
|--------|--------------|--------------|
| Preprocessing | ‚úÖ Stable (1200s avg) | ‚úÖ Works (1132s) |
| GPU Initialization | ‚úÖ Works | ‚ùå CUDNN fails |
| JAX Compatibility | ‚úÖ Full support | ‚ùå Initialization error |
| Production Ready | ‚úÖ Yes | ‚ùå No |

### Technical Details of Ubuntu 22.04 Failure

1. **Error Location**: `run_alphafold_inference.py:376` during `get_model_haiku_params()`
2. **Specific Issue**: CUDNN handle creation fails with `CUDNN_STATUS_NOT_INITIALIZED`
3. **When It Occurs**: Before any inference computation, during JAX array creation
4. **Not Related To**: 
   - Relaxation (we used `--use_gpu_relax=false`)
   - Model computation
   - Memory issues (94GB free)
5. **Root Cause**: Ubuntu 22.04 packages CUDNN differently, breaking JAX's initialization

### Recommendations

1. **Production Use**: Continue using Ubuntu 20.04 container
2. **Ubuntu 22.04**: Requires deeper investigation into CUDNN packaging
3. **Potential Fixes**:
   - Downgrade to older CUDNN version
   - Use NVIDIA's CUDNN container as base
   - Wait for JAX updates for Ubuntu 22.04 support

## Key Findings So Far

### Split Pipeline Advantages Validated
1. **Feature Reuse**: Saved 20 minutes by reusing preprocessed features for 1VII
2. **Resource Separation**: CPU preprocessing and GPU inference cleanly separated
3. **Multi-GPU Support**: Inference successfully distributed across 8 GPUs
4. **Memory Efficiency**: 44GB for preprocessing vs 12GB for inference

### Performance Metrics (1VII - 36 residues)
- **Preprocessing** (from previous run): 1200s (20 min), 44GB RAM
- **Inference**: 460s (7.7 min), 12GB RAM
- **Total Pipeline**: ~28 minutes (vs reused: 7.7 minutes)

### Container Configuration
- Ubuntu 20.04 Apptainer image working correctly
- All dependencies properly installed
- GPU access confirmed with proper bind mounts

## Technical Notes

1. **JAX Compilation**: First model takes longer due to compilation (~197s for model_1)
2. **Benchmark Mode**: Second run of each model excludes compilation time
3. **CPU Relaxation**: Using CPU relaxation due to H100 OpenMM compatibility

ü§ñ Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>