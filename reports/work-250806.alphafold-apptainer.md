# AlphaFold Apptainer Testing Framework Work Summary

**Date**: 2025-08-06  
**Project**: AlphaFold Apptainer/Singularity Testing and H100 Compatibility  
**Duration**: Single session work  

## Tasks Completed

### 1. Root Cause Analysis of H100 GPU Compatibility
- **Investigated** OpenMM PTX errors on H100 GPUs
- **Created** debug scripts to analyze OpenMM CUDA plugin
- **Discovered**: conda-forge OpenMM builds use runtime PTX compilation via NVRTC
- **Finding**: No pre-compiled PTX code for sm_90 (H100) in conda packages
- **Files**:
  - `/scratch/debug_openmm_cuda.sh` - Comprehensive debugging script
  - `/scratch/check_openmm_plugin.sh` - OpenMM plugin analysis
  - `/scratch/debug_openmm_output.log` - Debug results showing missing PTX

### 2. Solution Development for H100 Support
- **Created**: `alphafold_ubuntu22_openmm_source.def`
  - Builds OpenMM 8.2.0 from source with explicit H100 support
  - Includes `-gencode arch=compute_90,code=sm_90` compilation flag
  - Adds CUDA development tools for proper compilation
  - Should provide full GPU relaxation support on H100

### 3. Comprehensive Testing Framework
- **Designed** test plan for systematic evaluation of all definition files
- **Created** automated testing infrastructure:
  
#### Test Scripts Created:
1. **`/scratch/alphafold_test_plan.md`**
   - Detailed test matrix with 8 combinations
   - Expected results for each configuration
   - Provenance chain documentation

2. **`/scratch/run_alphafold_test.sh`**
   - Parameterized single test runner
   - Options: `-d` (definition), `-g` (GPU relax), `-n` (name), `-s` (skip build)
   - Automatic build, execution, and result analysis
   - JSON output with metrics (build time, test time, PTX errors)
   - Comprehensive logging

3. **`/scratch/run_all_alphafold_tests.sh`**
   - Master orchestrator for all tests
   - Runs 8 test combinations automatically
   - Generates comprehensive markdown report
   - Creates machine-readable JSON summary
   - Handles missing jq dependency with fallback parsing

4. **`/scratch/verify_test_setup.sh`**
   - Pre-test verification script
   - Checks all prerequisites
   - Reports disk space and existing images

5. **`/scratch/verify_dependencies.sh`**
   - Checks system dependencies
   - Verifies paths and permissions

6. **`/scratch/final_test_verification.sh`**
   - Comprehensive final check before testing
   - Summarizes all potential issues

### 4. Script Verification and Fixes
- **Fixed** path handling for both relative and absolute definition files
- **Added** `realpath` for proper path resolution
- **Fixed** build context directory change explanation
- **Added** definition file existence validation
- **Implemented** jq fallback for systems without it installed
- **Fixed** heredoc date expansion in report generation

## Code Changes Summary

### Files Created:
1. `alphafold_ubuntu22_openmm_source.def` - 280 lines (OpenMM from source)
2. `/scratch/alphafold_test_plan.md` - Comprehensive test plan
3. `/scratch/run_alphafold_test.sh` - 256 lines (parameterized test runner)
4. `/scratch/run_all_alphafold_tests.sh` - 230 lines (master test orchestrator)
5. `/scratch/verify_test_setup.sh` - Test setup verification
6. `/scratch/verify_dependencies.sh` - Dependency checker
7. `/scratch/final_test_verification.sh` - Final verification script
8. `/scratch/test_script_paths.sh` - Path handling test
9. Various debug and analysis scripts

### Files Modified:
1. `/scratch/run_alphafold_test.sh` - Added path validation and error handling
2. `/scratch/run_all_alphafold_tests.sh` - Added jq fallback parsing
3. Previous work summary updated with findings

## Technical Findings

### H100 GPU Compatibility:
1. **Root Cause**: conda-forge OpenMM packages lack pre-compiled PTX for sm_90
2. **OpenMM versions tested**: 8.0.0, 8.1.0, 8.2.0 (all fail on H100)
3. **Solution**: Build OpenMM from source with explicit H100 support
4. **Workaround**: CPU relaxation works perfectly with minimal performance impact

### Test Matrix Design:
- **5 definition files** tested with varying OpenMM versions
- **2 relaxation modes**: GPU (true) and CPU (false)
- **8 total test combinations** covering all scenarios
- **Expected outcomes** documented for each test

### Testing Infrastructure Features:
1. **Automated building** with timing metrics
2. **Precomputed MSA support** to save time
3. **Comprehensive logging** at every step
4. **JSON results** for programmatic analysis
5. **Markdown reports** for human consumption
6. **Provenance tracking** with full directory structure

## Next Steps

### Ready for Testing:
1. Run `/scratch/final_test_verification.sh` to confirm setup
2. Execute `/scratch/run_all_alphafold_tests.sh` for comprehensive testing
3. Review results in `/scratch/alphafold_tests/alphafold_test_report.md`

### Expected Outcomes:
- Standard conda-forge builds will fail GPU relaxation on H100
- Source-built OpenMM should succeed with GPU relaxation
- All definitions should work with CPU relaxation
- Ubuntu 20.04 and 22.04 should perform equivalently

## Notes
- Test framework uses precomputed features from `/scratch/alphafold_test_debug/`
- Each test creates isolated directory with full logging
- Results are preserved for debugging and analysis
- Framework is reusable for future AlphaFold testing

## Key Insights
1. **Version claims can be misleading** - OpenMM 8.2.0 "supports" H100 only if compiled correctly
2. **Build context matters** - Apptainer needs correct directory for `%files` section
3. **CPU relaxation is viable** - Performance impact is negligible for most use cases
4. **Automation is essential** - Manual testing of 8+ configurations would be error-prone