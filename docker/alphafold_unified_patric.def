Bootstrap: docker
From: nvidia/cuda:12.2.2-cudnn8-devel-ubuntu22.04

%post
    # Set non-interactive frontend and auto-accept conda terms
    export DEBIAN_FRONTEND=noninteractive
    export CONDA_PLUGINS_AUTO_ACCEPT_TOS="yes"
    
    # Create a build-specific temp directory to avoid host /tmp conflicts
    export TMPDIR=/var/tmp/alphafold-build
    mkdir -p $TMPDIR
    
    # Update and install system packages for both AlphaFold and Patric
    apt-get update --quiet
    apt-get install --no-install-recommends --yes --quiet --allow-change-held-packages \
        build-essential \
        cmake \
        cuda-command-line-tools-12-2 \
        git \
        hmmer \
        kalign \
        tzdata \
        wget \
        libcudnn8-dev \
        libcudnn8 \
        perl \
        cpanminus \
        libperl-dev \
        libjson-xs-perl \
        libdbi-perl \
        libdbix-class-perl \
        libmoose-perl \
        libnamespace-autoclean-perl \
        libplack-perl \
        libfile-slurp-perl \
        libtemplate-perl \
        unzip
    
    # Clean up apt cache
    rm -rf /var/lib/apt/lists/*
    apt-get autoremove --yes
    apt-get clean
    
    # Fix CUDNN symlinks for JAX compatibility (Ubuntu 22.04 specific)
    cd /usr/lib/x86_64-linux-gnu/
    for lib in libcudnn libcudnn_adv_infer libcudnn_adv_train libcudnn_cnn_infer libcudnn_cnn_train libcudnn_ops_infer libcudnn_ops_train; do
        if [ -f "${lib}.so.8.9.7" ]; then
            ln -sf "${lib}.so.8.9.7" "${lib}.so.8"
        elif [ -f "${lib}.so.8.9.6" ]; then
            ln -sf "${lib}.so.8.9.6" "${lib}.so.8"
        fi
    done
    
    # Additional CUDNN fix for Ubuntu 22.04
    if [ -f "/usr/lib/x86_64-linux-gnu/libcudnn.so.8.9.7" ]; then
        ln -sf /usr/lib/x86_64-linux-gnu/libcudnn.so.8.9.7 /usr/lib/x86_64-linux-gnu/libcudnn.so
    fi
    
    # Compile HHsuite from source
    git clone --branch v3.3.0 --single-branch https://github.com/soedinglab/hh-suite.git $TMPDIR/hh-suite \
    && mkdir $TMPDIR/hh-suite/build \
    && cd $TMPDIR/hh-suite/build \
    && cmake -DCMAKE_INSTALL_PREFIX=/opt/hhsuite .. \
    && make -j$(nproc) \
    && make install \
    && ln -s /opt/hhsuite/bin/* /usr/bin \
    && cd / \
    && rm -rf $TMPDIR/hh-suite
    
    # Install Miniconda
    wget -q -P $TMPDIR https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh \
    && bash $TMPDIR/Miniconda3-latest-Linux-x86_64.sh -b -p /opt/conda \
    && rm $TMPDIR/Miniconda3-latest-Linux-x86_64.sh
    
    # Set up conda paths
    export PATH="/opt/conda/bin:$PATH"
    export LD_LIBRARY_PATH="/opt/conda/lib:$LD_LIBRARY_PATH"
    
    # Install Conda packages with auto-accept ToS
    /opt/conda/bin/conda install --quiet --yes conda==24.11.1 pip python=3.11 \
    && /opt/conda/bin/conda install --quiet --yes --channel nvidia cuda=12.2.2 \
    && /opt/conda/bin/conda install --quiet --yes --channel conda-forge openmm=8.0.0 pdbfixer \
    && /opt/conda/bin/conda clean --all --force-pkgs-dirs --yes
    
    # Create app directory
    mkdir -p /app/alphafold
    
    # Download stereo_chemical_props.txt
    wget -q -P /app/alphafold/alphafold/common/ \
        https://git.scicore.unibas.ch/schwede/openstructure/-/raw/7102c63615b64735c4941278d92b554ec94415f8/modules/mol/alg/src/stereo_chemical_props.txt
    
    # Create Patric runtime directories
    mkdir -p /opt/patric-common/runtime
    mkdir -p /opt/patric-common/bin
    mkdir -p /opt/patric-common/lib
    
    # Create BV-BRC integration directories
    mkdir -p /app/bvbrc
    
    # Add SETUID bit to ldconfig for non-root GPU access
    chmod u+s /sbin/ldconfig.real || chmod u+s /sbin/ldconfig || true
    
    # Install essential Perl modules for BV-BRC
    cpanm --notest --quiet \
        JSON \
        JSON::XS \
        File::Slurp \
        File::Temp \
        File::Path \
        File::Basename \
        Data::Dumper \
        POSIX \
        DBI \
        Template \
        Plack \
        Moose \
        namespace::autoclean \
        Config::Simple \
        LWP::UserAgent \
        HTTP::Request::Common \
        URI \
        DateTime
    
    # Run ldconfig during build to create library cache
    ldconfig

%files
    # Copy the entire alphafold directory into the container
    . /app/alphafold
    # Explicitly copy patric.tar to ensure it's included (74GB file)
    ../patric.tar /app/alphafold/patric.tar
    # Copy AlphaFoldApp for BV-BRC integration (correct path from docker directory)
    ../../AlphaFoldApp /app/local_AlphaFoldApp
    # Copy dev_container excluding the problematic runtime symlink (correct path from docker directory)
    ../../dev_container/bootstrap /app/local_dev_container/bootstrap
    ../../dev_container/checkout-bvbrc-modules /app/local_dev_container/checkout-bvbrc-modules
    ../../dev_container/Makefile /app/local_dev_container/Makefile
    ../../dev_container/tools/ /app/local_dev_container/tools/
    # Copy Python environment wrapper to resolve conflicts
    unified_python_wrapper.sh /tmp/unified_python_wrapper.sh

%post
    # Second %post section - runs AFTER files are copied
    # This is necessary because we need requirements.txt from the copied files
    # Install pip packages after files are copied
    export PATH="/opt/conda/bin:$PATH"
    export PYTHONNOUSERSITE=1
    export TMPDIR=/var/tmp/alphafold-build
    
    # Upgrade pip first
    /opt/conda/bin/pip install --upgrade pip --no-cache-dir
    
    # Install requirements
    /opt/conda/bin/pip install -r /app/alphafold/requirements.txt --no-cache-dir
    
    # Install JAX with CUDA 12.2 support (matching Dockerfile)
    /opt/conda/bin/pip install --upgrade --no-cache-dir \
        jax==0.4.26 \
        jaxlib==0.4.26+cuda12.cudnn89 \
        -f https://storage.googleapis.com/jax-releases/jax_cuda_releases.html
    
    # Extract Patric runtime from the copied alphafold directory
    cd /opt/patric-common/runtime
    if [ -f /app/alphafold/patric.tar ]; then
        tar -xf /app/alphafold/patric.tar --strip-components=3
        rm /app/alphafold/patric.tar
    else
        echo "ERROR: patric.tar not found in /app/alphafold/"
        exit 1
    fi
    
    # BV-BRC dev_container integration
    echo "=== Setting up BV-BRC dev_container environment ==="
    cd /app/bvbrc
    
    # Clone dev_container repository (use local copy if available)
    if [ -d "/app/local_dev_container" ]; then
        echo "Using local dev_container copy"
        cp -r /app/local_dev_container dev_container
        # Create the runtime symlink pointing to our Patric runtime
        ln -sf /opt/patric-common/runtime dev_container/runtime
    else
        echo "Cloning dev_container from GitHub"
        git clone https://github.com/BV-BRC/dev_container.git
        # Create the runtime symlink pointing to our Patric runtime
        ln -sf /opt/patric-common/runtime dev_container/runtime
    fi
    
    cd /app/bvbrc/dev_container
    
    # Make bootstrap executable
    chmod +x bootstrap checkout-bvbrc-modules
    
    # Run checkout-bvbrc-modules to get core BV-BRC modules
    echo "Checking out BV-BRC modules..."
    ./checkout-bvbrc-modules
    
    # Copy our local AlphaFoldApp into modules directory
    echo "Integrating AlphaFoldApp..."
    if [ -d "/app/local_AlphaFoldApp" ]; then
        cp -r /app/local_AlphaFoldApp modules/AlphaFoldApp
    else
        echo "Warning: Local AlphaFoldApp not found"
    fi
    
    # Bootstrap with our existing Patric runtime
    echo "Bootstrapping dev_container with Patric runtime..."
    ./bootstrap /opt/patric-common/runtime
    
    # Source the environment (need to do this in a way that persists)
    echo "Setting up BV-BRC build environment..."
    export KB_TOP="/app/bvbrc/dev_container"
    export KB_RUNTIME="/opt/patric-common/runtime"
    export PATH="$KB_TOP/bin:$KB_RUNTIME/bin:$PATH"
    export PERL5LIB="$KB_TOP/lib:$KB_RUNTIME/lib:$PERL5LIB"
    
    # Build all modules
    echo "Building BV-BRC modules..."
    make || echo "Some modules may have failed to build - continuing..."
    
    # Create symlinks for Patric tools in unified bin directory
    find /opt/patric-common/runtime -name "*.pl" -type f -executable | while read -r script; do
        basename_script=$(basename "$script")
        ln -sf "$script" "/opt/patric-common/bin/$basename_script"
    done
    
    find /opt/patric-common/runtime -name "*.py" -type f -executable | while read -r script; do
        basename_script=$(basename "$script")
        ln -sf "$script" "/opt/patric-common/bin/$basename_script"
    done
    
    # Make Patric scripts executable
    find /opt/patric-common/runtime -name "*.pl" -exec chmod +x {} \;
    find /opt/patric-common/runtime -name "*.py" -exec chmod +x {} \;
    
    # Copy unified Python wrapper to resolve Python environment conflicts
    cp /tmp/unified_python_wrapper.sh /app/unified_python_wrapper.sh
    chmod +x /app/unified_python_wrapper.sh
    
    # Create unified BV-BRC environment setup script
    cat > /app/bvbrc/setup_bvbrc_env.sh << 'EOF'
#!/bin/bash
# Unified BV-BRC + Patric + AlphaFold environment setup

# Source BV-BRC dev_container environment
if [ -f "/app/bvbrc/dev_container/user-env.sh" ]; then
    source /app/bvbrc/dev_container/user-env.sh
fi

# Override KB paths for integrated approach
export KB_TOP="/app/bvbrc/dev_container"
export KB_RUNTIME="/opt/patric-common/runtime"

# Integrate with existing Patric environment
export PATRIC_RUNTIME="/opt/patric-common/runtime"
export PERL5LIB="/app/bvbrc/dev_container/lib:/opt/patric-common/runtime/lib:$PERL5LIB"
export PATH="/app/bvbrc/dev_container/bin:/opt/patric-common/bin:$PATH"

# Set AlphaFold integration variables for self-contained execution
export ALPHAFOLD_CONTAINER_SELF="true"
export ALPHAFOLD_PYTHON_PATH="/app/alphafold"
export ALPHAFOLD_DATA_DIR="/databases"

# CRITICAL: Python environment integration fix
# Build unified PYTHONPATH combining all environments
export PYTHONPATH="/app/alphafold:/app/bvbrc/dev_container/lib:/opt/patric-common/runtime/lib:/opt/patric-common/runtime/lib/python3.10/site-packages:$PYTHONPATH"

# Use unified Python wrapper to resolve Python version conflicts
alias python="/app/unified_python_wrapper.sh"
alias python3="/app/unified_python_wrapper.sh"

# BV-BRC workspace and authentication setup
export P3_AUTH_TOKEN_CACHE="$HOME/.patric_token"
export KB_SERVICE_DIR="/app/bvbrc/dev_container"
EOF
    chmod +x /app/bvbrc/setup_bvbrc_env.sh
    
    # Create environment setup scripts (keep existing for compatibility)
    cat > /opt/patric-common/setup_patric_env.sh << 'EOF'
#!/bin/bash
export PATRIC_RUNTIME="/opt/patric-common/runtime"
export PERL5LIB="/opt/patric-common/runtime/lib:$PERL5LIB"
export KB_TOP="/opt/patric-common/runtime"
export KB_RUNTIME="/opt/patric-common/runtime"
export PATH="/opt/patric-common/bin:$PATH"
EOF
    chmod +x /opt/patric-common/setup_patric_env.sh
    
    # Create AlphaFold run script with proper GPU initialization
    cat > /app/run_alphafold.sh << 'EOF'
#!/bin/bash
# Update library cache for GPU visibility
ldconfig 2>/dev/null || true
# Run AlphaFold with all arguments
exec python /app/alphafold/run_alphafold.py "$@"
EOF
    chmod +x /app/run_alphafold.sh
    
    # Create BV-BRC service wrapper
    cat > /app/run_bvbrc_service.sh << 'EOF'
#!/bin/bash
# Set up integrated BV-BRC environment
source /app/bvbrc/setup_bvbrc_env.sh

# Update library cache for GPU visibility
ldconfig 2>/dev/null || true

# Execute BV-BRC AlphaFold service with integrated environment
exec perl /app/bvbrc/dev_container/modules/AlphaFoldApp/service-scripts/App-AlphaFold.pl "$@"
EOF
    chmod +x /app/run_bvbrc_service.sh
    
    # Create BV-BRC development environment wrapper
    cat > /app/run_bvbrc_dev.sh << 'EOF'
#!/bin/bash
# Set up integrated BV-BRC development environment
source /app/bvbrc/setup_bvbrc_env.sh

echo "BV-BRC Development Environment"
echo "=============================="
echo "KB_TOP: $KB_TOP"
echo "KB_RUNTIME: $KB_RUNTIME"
echo "AlphaFold Integration: $ALPHAFOLD_CONTAINER_SELF"
echo
echo "Available commands:"
echo "  - p3-* commands: BV-BRC CLI tools"
echo "  - /app/alphafold/run_alphafold.py: Direct AlphaFold execution"
echo "  - make: Build BV-BRC modules"
echo
echo "AlphaFoldApp service script: /app/bvbrc/dev_container/modules/AlphaFoldApp/service-scripts/App-AlphaFold.pl"
echo

# Start interactive shell with environment
exec /bin/bash
EOF
    chmod +x /app/run_bvbrc_dev.sh
    
    # Create BV-BRC test wrapper
    cat > /app/run_bvbrc_test.sh << 'EOF'
#!/bin/bash
# Set up integrated BV-BRC environment
source /app/bvbrc/setup_bvbrc_env.sh

echo "Running BV-BRC Integration Tests..."
echo "==================================="

# Test 1: Environment setup
echo "Test 1: Environment Setup"
echo "  KB_TOP: $KB_TOP"
echo "  KB_RUNTIME: $KB_RUNTIME"
echo "  ALPHAFOLD_CONTAINER_SELF: $ALPHAFOLD_CONTAINER_SELF"

# Test 2: Perl modules
echo
echo "Test 2: Perl Module Availability"
perl -e "use JSON; use Bio::KBase::AppService::AppScript; print 'Perl modules OK\n'" || echo "Perl modules FAILED"

# Test 3: BV-BRC tools
echo
echo "Test 3: BV-BRC Tools"
which p3-whoami > /dev/null && echo "p3-whoami: OK" || echo "p3-whoami: MISSING"

# Test 4: AlphaFold integration
echo
echo "Test 4: AlphaFold Integration"
[ -f "/app/alphafold/run_alphafold.py" ] && echo "AlphaFold script: OK" || echo "AlphaFold script: MISSING"

# Test 5: AlphaFoldApp service
echo
echo "Test 5: AlphaFoldApp Service"
[ -f "/app/bvbrc/dev_container/modules/AlphaFoldApp/service-scripts/App-AlphaFold.pl" ] && echo "Service script: OK" || echo "Service script: MISSING"

echo
echo "BV-BRC Integration test completed."
echo "Run specific tests with additional arguments if needed."
EOF
    chmod +x /app/run_bvbrc_test.sh
    
    # Create Patric tools wrapper
    cat > /app/run_patric_env.sh << 'EOF'
#!/bin/bash
# Set up Patric environment
source /opt/patric-common/setup_patric_env.sh
# Execute command with Patric environment
exec "$@"
EOF
    chmod +x /app/run_patric_env.sh
    
    # Create unified test script
    cat > /app/test_unified.py << 'EOF'
#!/opt/conda/bin/python
import sys
import os
import subprocess
print("Testing Unified AlphaFold + Patric Container...")

# Suppress TF warnings during test
os.environ['TF_CPP_MIN_LOG_LEVEL'] = '2'

# Test 1: AlphaFold dependencies
print("\n=== Testing AlphaFold Dependencies ===")
try:
    import numpy as np
    print(f"✓ NumPy {np.__version__}")
    
    import jax
    print(f"✓ JAX {jax.__version__}")
    devices = jax.devices()
    print(f"  Devices: {devices}")
    if any('gpu' in str(d).lower() for d in devices):
        print("  ✓ GPU detected")
    else:
        print("  ⚠ No GPU detected - AlphaFold will run on CPU (slow)")
    
    import tensorflow as tf
    print(f"✓ TensorFlow {tf.__version__}")
    
    import alphafold
    print("✓ AlphaFold module imported successfully")
    
    # Test OpenMM
    import openmm
    print(f"✓ OpenMM {openmm.__version__}")
    
    print("✓ All AlphaFold dependencies loaded successfully!")
    
except Exception as e:
    print(f"✗ AlphaFold Error: {e}")
    import traceback
    traceback.print_exc()

# Test 2: Patric tools availability
print("\n=== Testing Patric Runtime ===")
try:
    patric_tools = [
        '/opt/patric-common/bin/CoreSNP.py',
        '/opt/patric-common/runtime/KronaTools-v2.8.1/install.pl'
    ]
    
    for tool in patric_tools:
        if os.path.exists(tool):
            print(f"✓ Found {os.path.basename(tool)}")
        else:
            print(f"✗ Missing {os.path.basename(tool)}")
    
    # Test Perl environment
    result = subprocess.run(['perl', '-e', 'use JSON; print "JSON module OK\n"'], 
                          capture_output=True, text=True)
    if result.returncode == 0:
        print("✓ Perl JSON module available")
    else:
        print("✗ Perl JSON module missing")
        
    print("✓ Patric runtime validation completed!")
    
except Exception as e:
    print(f"✗ Patric Error: {e}")

# Test 3: Environment variables
print("\n=== Testing Environment Variables ===")
important_vars = ['PATH', 'PYTHONPATH', 'LD_LIBRARY_PATH', 'CUDA_HOME']
for var in important_vars:
    value = os.environ.get(var, 'NOT SET')
    print(f"{var}: {value[:100]}{'...' if len(str(value)) > 100 else ''}")

print("\n=== Test Summary ===")
print("Container integration test completed!")
print("Use specific apps for detailed testing:")
print("  - apptainer run --app test container.sif")
print("  - apptainer run --app bvbrc container.sif --help")
print("  - apptainer run --app patric-env container.sif CoreSNP.py --help")
EOF
    chmod +x /app/test_unified.py
    
    # Clean up to reduce image size
    /opt/conda/bin/conda clean --all --force-pkgs-dirs --yes
    /opt/conda/bin/pip cache purge
    apt-get autoremove --yes
    apt-get clean
    rm -rf /var/lib/apt/lists/*
    # Clean up our build directory
    rm -rf $TMPDIR
    
    # Final ldconfig to ensure all libraries are found
    ldconfig

%environment
    # Core paths - AlphaFold takes precedence
    export PATH="/opt/conda/bin:/opt/hhsuite/bin:/opt/patric-common/bin:$PATH"
    export LD_LIBRARY_PATH="/opt/conda/lib:/usr/local/cuda-12.2/lib64:/usr/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH"
    export PYTHONPATH="/app/alphafold:$PYTHONPATH"
    
    # Conda settings
    export CONDA_PLUGINS_AUTO_ACCEPT_TOS="yes"
    export PYTHONNOUSERSITE=1
    
    # CUDA/JAX settings for optimal performance
    export CUDA_HOME="/usr/local/cuda-12.2"
    export CUDNN_PATH="/usr/lib/x86_64-linux-gnu"
    export XLA_FLAGS="--xla_gpu_cuda_data_dir=/usr/local/cuda-12.2 --xla_gpu_force_compilation_parallelism=1"
    export XLA_PYTHON_CLIENT_PREALLOCATE=false
    export XLA_PYTHON_CLIENT_MEM_FRACTION=0.90
    export TF_FORCE_GPU_ALLOW_GROWTH=true
    export CUDA_MODULE_LOADING=EAGER
    
    # Patric runtime settings (for compatibility)
    export PATRIC_RUNTIME="/opt/patric-common/runtime"
    export PERL5LIB="/opt/patric-common/runtime/lib:$PERL5LIB"
    export KB_TOP="/opt/patric-common/runtime"
    export KB_RUNTIME="/opt/patric-common/runtime"
    
    # BV-BRC integration paths
    export BV_BRC_DEV_CONTAINER="/app/bvbrc/dev_container"
    export BV_BRC_RUNTIME="/opt/patric-common/runtime"
    export ALPHAFOLD_CONTAINER_SELF="true"
    
    # Working directory
    export WORKDIR="/app/alphafold"

%runscript
    # Default: Run AlphaFold
    cd /app/alphafold
    exec /app/run_alphafold.sh "$@"

%apprun bvbrc
    # BV-BRC service mode - integrated environment
    exec /app/run_bvbrc_service.sh "$@"

%apprun bvbrc-dev
    # BV-BRC development environment
    exec /app/run_bvbrc_dev.sh "$@"

%apprun bvbrc-test
    # BV-BRC integration testing
    exec /app/run_bvbrc_test.sh "$@"

%apprun patric-env
    # Patric tools environment
    exec /app/run_patric_env.sh "$@"

%apprun test
    # Testing mode
    exec /app/test_unified.py "$@"

%apphelp bvbrc
    BV-BRC AlphaFold Service Mode (Integrated)
    
    Usage:
    apptainer run --app bvbrc container.sif job_id app_definition_file parameters_file
    
    This mode provides the fully integrated BV-BRC service wrapper around AlphaFold.
    The service runs within the container's integrated BV-BRC dev_container environment,
    eliminating the need for external mounts or container-in-container execution.
    
    Features:
    - Self-contained execution (no external container required)
    - Integrated BV-BRC + Patric + AlphaFold environment
    - Direct access to AlphaFold prediction pipeline
    - Workspace integration for input/output handling
    
%apphelp bvbrc-dev
    BV-BRC Development Environment
    
    Usage:
    apptainer run --app bvbrc-dev container.sif
    
    Provides an interactive development environment with:
    - Complete BV-BRC dev_container setup
    - Access to p3-* command line tools
    - AlphaFold integration testing
    - Module building and development tools
    
%apphelp bvbrc-test
    BV-BRC Integration Testing
    
    Usage:
    apptainer run --app bvbrc-test container.sif
    
    Runs comprehensive integration tests to validate:
    - BV-BRC environment setup
    - Perl module dependencies
    - AlphaFold integration
    - Service script availability
    - Tool accessibility

%apphelp patric-env
    Patric Tools Environment Mode
    
    Usage:
    apptainer run --app patric-env container.sif <tool> [args...]
    
    Examples:
    apptainer run --app patric-env container.sif CoreSNP.py --help
    apptainer run --app patric-env container.sif perl -e "use JSON; print 'OK\n'"
    
    This mode provides access to Patric bioinformatics tools with
    the proper runtime environment configured.

%apphelp test
    Container Testing Mode
    
    Usage:
    apptainer run --app test container.sif
    
    Validates that all container components are properly integrated:
    - AlphaFold dependencies (JAX, TensorFlow, OpenMM)
    - Patric runtime tools availability
    - Environment variable configuration
    - Component integration status

%labels
    Author DeepMind Technologies Limited / BV-BRC / Patric Runtime Integration
    Version alphafold-2.3.2-ubuntu22.04-bvbrc-integrated
    CUDA-Version 12.2.2
    JAX-Version 0.4.26
    Python-Version 3.11
    Description Integrated AlphaFold + BV-BRC dev_container + Patric Runtime Container

%help
    Integrated AlphaFold v2.3.2 + BV-BRC dev_container + Patric Runtime Container
    
    This container provides a fully integrated environment combining:
    1. AlphaFold v2.3.2 - Protein structure prediction
    2. BV-BRC dev_container - Complete BV-BRC development environment
    3. Patric Runtime - Bioinformatics tools and utilities (70GB toolchain)
    4. AlphaFoldApp Service - Integrated BV-BRC service for AlphaFold
    
    The integration eliminates external dependencies and provides a self-contained
    environment for BV-BRC AlphaFold services.
    
    === Usage Modes ===
    
    1. AlphaFold Prediction (default):
    apptainer run --nv container.sif \
      --fasta_paths=<path_to_fasta> \
      --max_template_date=2022-01-01 \
      --db_preset=<reduced_dbs|full_dbs> \
      --model_preset=<monomer|monomer_casp14|monomer_ptm|multimer> \
      --data_dir=<path_to_databases> \
      --output_dir=<output_path>
    
    2. BV-BRC Service (Integrated):
    apptainer run --app bvbrc --nv container.sif \
      job_id app_definition.json parameters.json
    
    3. BV-BRC Development:
    apptainer run --app bvbrc-dev container.sif
    
    4. BV-BRC Integration Testing:
    apptainer run --app bvbrc-test container.sif
    
    5. Patric Tools:
    apptainer run --app patric-env container.sif \
      CoreSNP.py [arguments]
    
    6. Container Testing:
    apptainer run --app test container.sif
    
    === Model Presets ===
    - monomer: Single chain prediction (fastest)
    - monomer_casp14: 8 model ensemble as used in CASP14
    - monomer_ptm: Single chain with pTM score and PAE
    - multimer: Multi-chain complex prediction
    
    === Database Presets ===
    - reduced_dbs: Uses small_bfd (faster, less accurate)
    - full_dbs: Full BFD database (slower, more accurate)
    
    === Notes ===
    - The --nv flag is REQUIRED for GPU support
    - Ensure databases are downloaded to data_dir
    - H100 GPUs: Use --use_gpu_relax=false due to OpenMM compatibility
    - Container supports multiple simultaneous tool environments